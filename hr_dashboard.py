import streamlit as st
import pandas as pd
import altair as alt
import datetime
import os
import pytz
import json
import firebase_admin
from firebase_admin import credentials, firestore
import bcrypt

# -----------------------------
# Page Setup and Styling
# -----------------------------
st.set_page_config(
    page_title="HR Dashboard",
    page_icon="üìä",
    layout="wide"
)

# Hide default Streamlit UI
hide_streamlit_style = """
            <style>
            #MainMenu {visibility: hidden;}
            footer {visibility: hidden;}
            header {visibility: hidden;}
            </style>
            """
st.markdown(hide_streamlit_style, unsafe_allow_html=True)

# -----------------------------
# Timezone and Date Functions
# -----------------------------
bangkok_tz = pytz.timezone("Asia/Bangkok")

def thai_date(dt):
    """Converts a datetime object to a Thai date string (Buddhist year)."""
    if pd.isna(dt):
        return "N/A"
    return dt.strftime(f"%d/%m/{dt.year + 543}")

def format_time(dt):
    """Converts a datetime object to a time string (HH:MM)."""
    if pd.isna(dt) or (isinstance(dt, datetime.time) and dt == datetime.time(0, 0)):
        return "00:00"
    return dt.strftime("%H:%M")

# -----------------------------
# Data Handling (load_data and process_user_data remain unchanged)
# -----------------------------
@st.cache_data
def load_data(file_path="attendances.xlsx"):
    """Loads data from an Excel or CSV file and returns a DataFrame."""
    file_extension = os.path.splitext(file_path)[1].lower()
    
    if not os.path.exists(file_path):
        st.warning(f"‚ùå Data file not found: {file_path}")
        return pd.DataFrame()

    try:
        if file_extension in ['.xlsx', '.xls']:
            df = pd.read_excel(file_path, engine='openpyxl')
        elif file_extension == '.csv':
            df = pd.read_csv(file_path)
        else:
            st.error(f"Unsupported file format: {file_extension}")
            return pd.DataFrame()
        
        # Data cleaning and type conversion
        if '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' in df.columns:
            df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] = pd.to_datetime(df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'], errors='coerce')
        if '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' in df.columns:
            df['‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô'] = df['‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô'].replace('-', None)
            df['‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô'] = pd.to_datetime(df['‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô'], format='%H:%M:%S', errors='coerce').dt.time
        if '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô' in df.columns:
            df['‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô'] = df['‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô'].replace('-', None)
            df['‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô'] = pd.to_datetime(df['‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô'], format='%H:%M:%S', errors='coerce').dt.time

        return df
    except Exception as e:
        st.error(f"Error reading file: {e}")
        return pd.DataFrame()

def process_user_data(df, user_name):
    """Processes attendance data for a specific user."""
    if df.empty or "‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" not in df.columns:
        return pd.DataFrame(), pd.DataFrame()

    # Normalize user name from Firebase
    normalized_user_name = user_name.strip().lower()

    # Normalize names in the DataFrame for comparison
    df["‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•_normalized"] = df["‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"].astype(str).str.strip().str.lower()
    
    # Filter the DataFrame using the normalized names
    df_user = df[df["‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•_normalized"] == normalized_user_name].copy()
    if df_user.empty:
        return pd.DataFrame(), pd.DataFrame()

    # Clean up string columns
    for col in ["‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•", "‡πÅ‡∏ú‡∏ô‡∏Å", "‡∏Ç‡πâ‡∏≠‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô"]:
        if col in df_user.columns:
            df_user[col] = df_user[col].astype(str).str.strip().str.replace(r"\s+", " ", regex=True)
    if "‡πÅ‡∏ú‡∏ô‡∏Å" in df_user.columns:
        df_user["‡πÅ‡∏ú‡∏ô‡∏Å"] = df_user["‡πÅ‡∏ú‡∏ô‡∏Å"].replace({"nan": "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏", "": "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"})
    
    # Calculate leave days
    def leave_days(exception_text):
        return 0.5 if "‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô" in str(exception_text) else 1

    df_user["‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤‡∏Å‡∏¥‡∏à"] = df_user["‡∏Ç‡πâ‡∏≠‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô"].apply(
        lambda x: leave_days(x) if str(x) in ["‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢", "‡∏•‡∏≤‡∏Å‡∏¥‡∏à", "‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô", "‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô"] else 0)
    df_user["‡∏Ç‡∏≤‡∏î"] = df_user["‡∏Ç‡πâ‡∏≠‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô"].apply(
        lambda x: leave_days(x) if str(x) in ["‡∏Ç‡∏≤‡∏î", "‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô"] else 0)
    df_user["‡∏™‡∏≤‡∏¢"] = df_user["‡∏Ç‡πâ‡∏≠‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô"].apply(lambda x: 1 if str(x) == "‡∏™‡∏≤‡∏¢" else 0)
    df_user["‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô"] = df_user["‡∏Ç‡πâ‡∏≠‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô"].apply(lambda x: 1 if str(x) == "‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô" else 0)

    leave_types = ["‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤‡∏Å‡∏¥‡∏à", "‡∏Ç‡∏≤‡∏î", "‡∏™‡∏≤‡∏¢", "‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô"]
    summary_df = df_user.groupby("‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•")[leave_types].sum().reset_index()
    return df_user, summary_df

# -----------------------------
# Firebase Integration
# -----------------------------

# Initialize Firebase (run only once)
if not firebase_admin._apps:
    try:
        # Load the secrets object from Streamlit
        service_account_info = st.secrets["firebase"]
        
        # Convert the Streamlit object to a standard Python dictionary
        # This is a robust way to handle the object from st.secrets
        firebase_config_dict = dict(service_account_info)
        
        # Now pass the standard dictionary to credentials.Certificate
        cred = credentials.Certificate(firebase_config_dict)
        firebase_admin.initialize_app(cred)
    except Exception as e:
        st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase: {e}")
        st.info("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ `secrets` ‡∏ö‡∏ô Streamlit Cloud ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")
        st.stop()

def load_user_db():
    """Loads the user database from Firestore."""
    try:
        db = firestore.client()
        users_ref = db.collection("users")
        users_dict = {}
        for doc in users_ref.stream():
            users_dict[doc.id] = doc.to_dict()
        return users_dict
    except Exception as e:
        st.error(f"Error loading user database from Firestore: {e}")
        return {}

def save_user_db(phone, user_data):
    """Saves a single user's data to Firestore for improved efficiency."""
    try:
        db = firestore.client()
        db.collection("users").document(phone).set(user_data)
    except Exception as e:
        st.error(f"Error saving user data to Firestore: {e}")

# Initialize session state
if "step" not in st.session_state:
    st.session_state.step = "login"
    st.session_state.phone = ""
    st.session_state.user = ""

def logout():
    """Clears the session state and returns to the login page."""
    for key in list(st.session_state.keys()):
        if key not in ['firebase_config_dict']:
            del st.session_state[key]
    st.session_state.step = "login"
    st.rerun()

# -----------------------------
# UI Display Functions
# -----------------------------

def display_login_page():
    """Displays the login form."""
    USERS_DB = load_user_db()
    st.title("üìä HR Dashboard")
    st.markdown("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì")

    col1, col2, col3 = st.columns([1, 1.5, 1])

    with col2:
        with st.container(border=True):
            st.markdown("#### <div style='text-align: center;'>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>", unsafe_allow_html=True)
            
            phone = st.text_input(
                "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå",
                placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå 10 ‡∏´‡∏•‡∏±‡∏Å",
                max_chars=10
            )
            password = st.text_input(
                "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô",
                type="password",
                placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"
            )

            if st.button("‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö", use_container_width=True, type="primary"):
                if phone in USERS_DB:
                    user_data = USERS_DB[phone]
                    # Check for "null" string, None, or empty string before proceeding
                    if user_data.get("password") in ["null", None, ""]:
                        st.session_state.phone = phone
                        st.session_state.step = "set_password"
                        st.rerun()
                    # Now it's safe to check the password with bcrypt
                    elif bcrypt.checkpw(password.encode('utf-8'), user_data.get("password").encode('utf-8')):
                        st.session_state.user = user_data["name"]
                        st.session_state.phone = phone
                        st.session_state.step = "dashboard"
                        st.rerun()
                    else:
                        st.error("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")
                else:
                    st.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö")

            st.markdown("---")
            if st.button("üîí ‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", use_container_width=True):
                st.session_state.step = "forgot_password"
                st.rerun()
                
def display_password_page(mode="set"):
    """Displays the page for setting or changing a password."""
    USERS_DB = load_user_db()
    title_map = {"set": "‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å", "change": "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"}
    title = title_map.get(mode, "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô")
    st.title(f"üîë {title}")

    col1, col2, col3 = st.columns([1, 1.5, 1])
    with col2:
        with st.container(border=True):
            st.markdown(f"#### <div style='text-align: center;'>{title}</div>", unsafe_allow_html=True)
            st.info(f"‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: {st.session_state.phone}")

            if mode == "change":
                current_password = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô", type="password")
            
            new_password = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà", type="password")
            confirm_password = st.text_input("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà", type="password")

            if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", use_container_width=True, type="primary"):
                user_data = USERS_DB[st.session_state.phone]
                
                # Check current password only in change mode
                if mode == "change" and not bcrypt.checkpw(current_password.encode('utf-8'), user_data.get("password").encode('utf-8')):
                    st.error("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")
                elif not new_password:
                    st.error("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á")
                elif new_password != confirm_password:
                    st.error("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô")
                else:
                    # Hash the new password before saving
                    hashed_password = bcrypt.hashpw(new_password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
                    user_data["password"] = hashed_password
                    save_user_db(st.session_state.phone, user_data)
                    st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")
                    if mode == "change":
                        st.session_state.step = "dashboard"
                    else: # mode == "set"
                        st.session_state.step = "login"
                    st.rerun()
                
            if mode == "set":
                if st.button("‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô", use_container_width=True):
                    logout()
            else:
                if st.button("‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î", use_container_width=True):
                    st.session_state.step = "dashboard"
                    st.rerun()

def display_forgot_password_page():
    """Displays the page for password reset with admin verification."""
    USERS_DB = load_user_db()
    st.title("üîí ‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô")
    st.markdown("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô")

    col1, col2, col3 = st.columns([1, 1.5, 1])
    with col2:
        with st.container(border=True):
            st.markdown("#### <div style='text-align: center;'>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</div>", unsafe_allow_html=True)
            
            user_phone = st.text_input(
                "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™", 
                placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå 10 ‡∏´‡∏•‡∏±‡∏Å", 
                max_chars=10
            )
            admin_phone = st.text_input(
                "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö", 
                placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö", 
                max_chars=10
            )
            admin_password = st.text_input(
                "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö", 
                type="password",
                placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö"
            )
            new_password = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà", type="password", key="new_password")
            confirm_password = st.text_input("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà", type="password", key="confirm_new_password")

            if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà", use_container_width=True, type="primary"):
                # Check if the user to be reset exists
                if user_phone not in USERS_DB:
                    st.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö")
                # Check if the admin exists and get their data
                elif admin_phone not in USERS_DB:
                    st.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö")
                else:
                    admin_data = USERS_DB[admin_phone]
                    # Check admin password
                    if not bcrypt.checkpw(admin_password.encode('utf-8'), admin_data.get("password", "").encode('utf-8')):
                        st.error("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")
                    # Validate new password
                    elif not new_password or new_password != confirm_password:
                        st.error("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á")
                    else:
                        hashed_password = bcrypt.hashpw(new_password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
                        USERS_DB[user_phone]["password"] = hashed_password
                        save_user_db(user_phone, USERS_DB[user_phone])
                        st.success("‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô")
                        st.session_state.step = "login"
                        st.rerun()

    if st.button("‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô", use_container_width=True):
        logout()


def display_dashboard():
    """Displays the user's dashboard."""
    with st.sidebar:
        st.header("‡πÄ‡∏°‡∏ô‡∏π")
        st.info(f"‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö,\n**{st.session_state.user}**")
        
        if st.button("üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"):
            st.session_state.step = "change_password"
            st.rerun()
        
        st.divider()
        st.button("üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö", on_click=logout, use_container_width=True)

    st.header("üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
    st.subheader(f"**{st.session_state.user}**")

    df_full = load_data()

    if not df_full.empty and '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' in df_full.columns:
        df_full_cleaned = df_full.dropna(subset=['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])
        if not df_full_cleaned.empty:
            start_date = df_full_cleaned['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'].min()
            end_date = df_full_cleaned['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'].max()
            st.markdown(
                f'<p style="font-size: 0.8rem; margin: 0;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <b>{thai_date(start_date)}</b> ‡∏ñ‡∏∂‡∏á <b>{thai_date(end_date)}</b></p>',
                unsafe_allow_html=True
            )
    st.divider()

    df_user, summary = process_user_data(df_full, st.session_state.user)

    if summary.empty:
        st.info("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì")
        return

    st.markdown("### üóìÔ∏è ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°")
    col1, col2, col3, col4 = st.columns(4)
    col1.metric("‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤‡∏Å‡∏¥‡∏à (‡∏ß‡∏±‡∏ô)", summary["‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤‡∏Å‡∏¥‡∏à"].sum())
    col2.metric("‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô (‡∏ß‡∏±‡∏ô)", summary["‡∏Ç‡∏≤‡∏î"].sum())
    col3.metric("‡∏°‡∏≤‡∏™‡∏≤‡∏¢ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)", int(summary["‡∏™‡∏≤‡∏¢"].sum()))
    col4.metric("‡∏ß‡∏±‡∏ô‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô (‡∏ß‡∏±‡∏ô)", int(summary["‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô"].sum()))
    st.divider()

    st.markdown("### üìà ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥")
    summary_melted = summary.melt(
        id_vars=["‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"],
        value_vars=["‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤‡∏Å‡∏¥‡∏à", "‡∏Ç‡∏≤‡∏î", "‡∏™‡∏≤‡∏¢", "‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô"],
        var_name="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó",
        value_name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô/‡∏Ñ‡∏£‡∏±‡πâ‡∏á"
    )
    chart = alt.Chart(summary_melted).mark_bar().encode(
        x=alt.X('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô/‡∏Ñ‡∏£‡∏±‡πâ‡∏á:Q', title='‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ß‡∏±‡∏ô/‡∏Ñ‡∏£‡∏±‡πâ‡∏á)'),
        y=alt.Y('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:N', title='‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó', sort='-x'),
        color=alt.Color('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:N', 
                         scale=alt.Scale(
                             domain=['‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤‡∏Å‡∏¥‡∏à', '‡∏Ç‡∏≤‡∏î', '‡∏™‡∏≤‡∏¢', '‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô'],
                             range=['#FFC300', '#C70039', '#FF5733', '#33C1FF']
                         ),
                         legend=None),
        tooltip=['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô/‡∏Ñ‡∏£‡∏±‡πâ‡∏á']
    ).properties(title='‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')
    st.altair_chart(chart, use_container_width=True)

    st.markdown("#### üìú ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà")
    leave_types_map = {
        "‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤‡∏Å‡∏¥‡∏à": ["‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢", "‡∏•‡∏≤‡∏Å‡∏¥‡∏à", "‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô", "‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô"],
        "‡∏Ç‡∏≤‡∏î": ["‡∏Ç‡∏≤‡∏î", "‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô"],
        "‡∏™‡∏≤‡∏¢": ["‡∏™‡∏≤‡∏¢"],
        "‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô": ["‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô"]
    }
    
    for leave_type, exceptions in leave_types_map.items():
        dates_df = df_user[df_user["‡∏Ç‡πâ‡∏≠‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô"].isin(exceptions)]
        total_days = df_user[leave_type].sum()
        if not dates_df.empty:
            with st.expander(f"‡∏î‡∏π‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà **{leave_type}** (‡∏£‡∏ß‡∏° {total_days} ‡∏ß‡∏±‡∏ô/‡∏Ñ‡∏£‡∏±‡πâ‡∏á)"):
                for _, row in dates_df.sort_values(by="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà").iterrows():
                    check_in_time = format_time(row.get('‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô'))
                    check_out_time = format_time(row.get('‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô'))
                    time_display = f' <span style="white-space: nowrap;">{check_in_time}-{check_out_time}</span>'

                    st.markdown(
                        f'<p style="font-size: 0.9rem; margin: 0;">- <b>{thai_date(row["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"])}</b>{time_display} ({row["‡∏Ç‡πâ‡∏≠‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô"]})</p>',
                        unsafe_allow_html=True
                    )

# -----------------------------
# Main App Logic
# -----------------------------
if st.session_state.step == "login":
    display_login_page()
elif st.session_state.step == "set_password":
    display_password_page(mode="set")
elif st.session_state.step == "change_password":
    display_password_page(mode="change")
elif st.session_state.step == "forgot_password":
    display_forgot_password_page()
elif st.session_state.step == "dashboard":
    display_dashboard()
else:
    display_login_page()
